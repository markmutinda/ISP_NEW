# -*- text -*-
##
## FreeRADIUS PostgreSQL Queries - Tenant: tenant_
##
## Auto-generated for Netily ISP multi-tenant RADIUS
## Schema: tenant_
##

# Safe characters for SQL queries
safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /+"

#######################################################################
# Authorization Queries - Schema: tenant_
#######################################################################

# Get check attributes for a user
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM tenant_.radcheck \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

# Get reply attributes for a user
authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM tenant_.radreply \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

# Group queries - using group tables for profile-based policies
authorize_group_check_query = "\
    SELECT radgroupcheck.id, radgroupcheck.groupname, radgroupcheck.attribute, \
           radgroupcheck.value, radgroupcheck.op \
    FROM tenant_.radusergroup \
    JOIN tenant_.radgroupcheck ON radusergroup.groupname = radgroupcheck.groupname \
    WHERE radusergroup.username = '%{SQL-User-Name}' \
    ORDER BY radusergroup.priority, radgroupcheck.id"

authorize_group_reply_query = "\
    SELECT radgroupreply.id, radgroupreply.groupname, radgroupreply.attribute, \
           radgroupreply.value, radgroupreply.op \
    FROM tenant_.radusergroup \
    JOIN tenant_.radgroupreply ON radusergroup.groupname = radgroupreply.groupname \
    WHERE radusergroup.username = '%{SQL-User-Name}' \
    ORDER BY radusergroup.priority, radgroupreply.id"

group_membership_query = "\
    SELECT groupname \
    FROM tenant_.radusergroup \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY priority"

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################

simul_count_query = "\
    SELECT COUNT(*) \
    FROM tenant_.radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

simul_verify_query = "\
    SELECT radacctid, acctsessionid, username, nasipaddress, nasportid, \
           framedipaddress, callingstationid, framedprotocol \
    FROM tenant_.radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

#######################################################################
# Accounting Queries
#######################################################################

accounting_start_query = "\
    INSERT INTO tenant_.radacct \
        (acctsessionid, acctuniqueid, username, realm, nasipaddress, \
         nasportid, nasporttype, acctstarttime, acctupdatetime, \
         acctstoptime, acctsessiontime, acctauthentic, connectinfo_start, \
         acctinputoctets, acctoutputoctets, calledstationid, \
         callingstationid, acctterminatecause, servicetype, framedprotocol, \
         framedipaddress) \
    VALUES \
        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
         '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', \
         '%{NAS-Port-Id}', '%{NAS-Port-Type}', NOW(), NOW(), \
         NULL, 0, '%{Acct-Authentic}', '%{Connect-Info}', \
         0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', \
         '', '%{Service-Type}', '%{Framed-Protocol}', \
         '%{Framed-IP-Address}')"

accounting_interim_query = "\
    UPDATE tenant_.radacct \
    SET acctupdatetime = NOW(), \
        acctinterval = %{%{Acct-Session-Time}:-0} - acctsessiontime, \
        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
        acctinputoctets = %{%{Acct-Input-Gigawords}:-0} * 4294967296 + %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Gigawords}:-0} * 4294967296 + %{%{Acct-Output-Octets}:-0}, \
        framedipaddress = '%{Framed-IP-Address}' \
    WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

accounting_stop_query = "\
    UPDATE tenant_.radacct \
    SET acctstoptime = NOW(), \
        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
        acctinputoctets = %{%{Acct-Input-Gigawords}:-0} * 4294967296 + %{%{Acct-Input-Octets}:-0}, \
        acctoutputoctets = %{%{Acct-Output-Gigawords}:-0} * 4294967296 + %{%{Acct-Output-Octets}:-0}, \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        framedipaddress = '%{Framed-IP-Address}' \
    WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

#######################################################################
# Post-Auth Logging
#######################################################################

post-auth {
    query = "\
        INSERT INTO tenant_.radpostauth \
            (username, password, reply, authdate, nasipaddress, callingstationid) \
        VALUES \
            ('%{SQL-User-Name}', \
             '%{%{User-Password}:-%{Chap-Password}}', \
             '%{reply:Packet-Type}', \
             NOW(), \
             '%{NAS-IP-Address}', \
             '%{Calling-Station-Id}')"
}
