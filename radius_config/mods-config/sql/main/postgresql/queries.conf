# -*- text -*-
##
## FreeRADIUS PostgreSQL Queries for Django Integration
##
## These queries work with Django's RADIUS models in the tenant schema.
## The schema is uses public schema for multi-tenant support - change this per deployment.
##

# Safe characters for SQL queries
safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /+"

#######################################################################
# Authorization Queries - Using schema-qualified table names
#######################################################################

# Get check attributes for a user
authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM radcheck \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

# Get reply attributes for a user
authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM radreply \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

# Group queries - simplified for now (not using group-based auth)
authorize_group_check_query = ""
authorize_group_reply_query = ""
group_membership_query = ""

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################

# Count active sessions for a user
simul_count_query = "\
    SELECT COUNT(*) \
    FROM radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

# Verify sessions are still active
simul_verify_query = "\
    SELECT radacctid, acctsessionid, username, nasipaddress, nasportid, \
           framedipaddress, callingstationid, framedprotocol \
    FROM radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

#######################################################################
# Accounting Queries
#######################################################################

# Insert new accounting record (Start)
accounting_start_query = "\
    INSERT INTO radacct \
        (acctsessionid, acctuniqueid, username, nasipaddress, \
         nasportid, nasporttype, acctstarttime, acctupdatetime, \
         acctsessiontime, acctauthentic, connectinfo_start, \
         acctinputoctets, acctoutputoctets, calledstationid, \
         callingstationid, servicetype, framedprotocol, \
         framedipaddress) \
    VALUES \
        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
         '%{SQL-User-Name}', '%{NAS-IP-Address}', \
         '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
         NOW(), NOW(), \
         0, '%{Acct-Authentic}', '%{Connect-Info}', \
         0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', \
         '%{Service-Type}', '%{Framed-Protocol}', \
         '%{Framed-IP-Address}')"

# Update accounting record (Interim-Update)
accounting_update_query = "\
    UPDATE radacct \
    SET acctupdatetime = NOW(), \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = '%{Acct-Input-Octets}', \
        acctoutputoctets = '%{Acct-Output-Octets}', \
        framedipaddress = '%{Framed-IP-Address}' \
    WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

# Update accounting record (Stop)
accounting_stop_query = "\
    UPDATE radacct \
    SET acctstoptime = NOW(), \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = '%{Acct-Input-Octets}', \
        acctoutputoctets = '%{Acct-Output-Octets}', \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        framedipaddress = '%{Framed-IP-Address}' \
    WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"

#######################################################################
# Post-Auth Logging
#######################################################################

post-auth {
    # Log authentication attempts
    query = "\
        INSERT INTO radpostauth \
            (username, pass, reply, authdate) \
        VALUES \
            ('%{SQL-User-Name}', \
             '%{%{User-Password}:-%{Chap-Password}}', \
             '%{reply:Packet-Type}', \
             NOW())"
}


