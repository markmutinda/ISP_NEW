# -*- text -*-
##
## FreeRADIUS PostgreSQL Queries for Django Integration
## Fixed Structure for Accounting
##

# Safe characters for SQL queries
safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /+"

#######################################################################
# Authorization Queries
#######################################################################

authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM radcheck \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM radreply \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_group_check_query = ""
authorize_group_reply_query = ""
group_membership_query = ""

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################

simul_count_query = "\
    SELECT COUNT(*) \
    FROM radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

simul_verify_query = "\
    SELECT radacctid, acctsessionid, username, nasipaddress, nasportid, \
           framedipaddress, callingstationid, framedprotocol \
    FROM radacct \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

#######################################################################
# Accounting Queries (FIXED: Wrapped in blocks)
#######################################################################

accounting {
    # 1. Start Session
    Start {
        query = "\
            INSERT INTO radacct \
                (acctsessionid, acctuniqueid, username, nasipaddress, \
                 nasportid, nasporttype, acctstarttime, acctupdatetime, \
                 acctsessiontime, acctauthentic, connectinfo_start, \
                 acctinputoctets, acctoutputoctets, calledstationid, \
                 callingstationid, servicetype, framedprotocol, \
                 framedipaddress) \
            VALUES \
                ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                 '%{SQL-User-Name}', '%{NAS-IP-Address}', \
                 '%{%{NAS-Port-ID}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
                 NOW(), NOW(), \
                 0, '%{Acct-Authentic}', '%{Connect-Info}', \
                 0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                 '%{Service-Type}', '%{Framed-Protocol}', \
                 '%{Framed-IP-Address}')"
    }

    # 2. Update Session (Interim-Update)
    Interim-Update {
        query = "\
            UPDATE radacct \
            SET acctupdatetime = NOW(), \
                acctsessiontime = '%{Acct-Session-Time}', \
                acctinputoctets = '%{Acct-Input-Octets}', \
                acctoutputoctets = '%{Acct-Output-Octets}', \
                framedipaddress = '%{Framed-IP-Address}' \
            WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
    }

    # 3. Stop Session
    Stop {
        query = "\
            UPDATE radacct \
            SET acctstoptime = NOW(), \
                acctsessiontime = '%{Acct-Session-Time}', \
                acctinputoctets = '%{Acct-Input-Octets}', \
                acctoutputoctets = '%{Acct-Output-Octets}', \
                acctterminatecause = '%{Acct-Terminate-Cause}', \
                framedipaddress = '%{Framed-IP-Address}' \
            WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
    }
}

#######################################################################
# Post-Auth Logging
#######################################################################

post-auth {
    query = "\
        INSERT INTO radpostauth \
            (username, pass, reply, authdate, nasipaddress, nasportid) \
        VALUES \
            ('%{SQL-User-Name}', \
             '%{%{User-Password}:-%{Chap-Password}}', \
             '%{reply:Packet-Type}', \
             NOW(), \
             '%{NAS-IP-Address}', \
             '%{NAS-Port-Id}')"
}