# ═══════════════════════════════════════════════════════════════════════════════
# FreeRADIUS SQL Module Configuration - Netily ISP
# ═══════════════════════════════════════════════════════════════════════════════
# 
# This configuration connects FreeRADIUS to PostgreSQL for:
#   - User authentication (radcheck, radreply)
#   - Group-based policies (radusergroup, radgroupcheck, radgroupreply)
#   - Session accounting (radacct)
#   - NAS/Client management (nas)
#   - Post-authentication logging (radpostauth)
#
# Environment Variables (substituted at container startup):
#   ${DB_HOST}     - PostgreSQL hostname
#   ${DB_PORT}     - PostgreSQL port
#   ${DB_USER}     - Database username
#   ${DB_PASSWORD} - Database password
#   ${DB_NAME}     - Database name
#
# Reference: https://wiki.freeradius.org/guide/SQL-HOWTO
# ═══════════════════════════════════════════════════════════════════════════════

sql {
    # ───────────────────────────────────────────────────────────────────────────
    # Driver Configuration
    # ───────────────────────────────────────────────────────────────────────────
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # ───────────────────────────────────────────────────────────────────────────
    # Database Connection
    # Environment variables are substituted by envsubst at container startup
    # ───────────────────────────────────────────────────────────────────────────
    server = "${DB_HOST}"
    port = ${DB_PORT}
    login = "${DB_USER}"
    password = "${DB_PASSWORD}"
    radius_db = "${DB_NAME}"

    # ───────────────────────────────────────────────────────────────────────────
    # Connection Pool Configuration
    # ───────────────────────────────────────────────────────────────────────────
    pool {
        start = 5
        min = 3
        max = 32
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    # ───────────────────────────────────────────────────────────────────────────
    # Table Names (using public schema for multi-tenant compatibility)
    # ───────────────────────────────────────────────────────────────────────────
    authcheck_table = "public.radcheck"
    authreply_table = "public.radreply"
    groupcheck_table = "public.radgroupcheck"
    groupreply_table = "public.radgroupreply"
    usergroup_table = "public.radusergroup"
    acct_table1 = "public.radacct"
    acct_table2 = "public.radacct"
    postauth_table = "public.radpostauth"
    client_table = "public.nas"

    # ───────────────────────────────────────────────────────────────────────────
    # Feature Flags
    # ───────────────────────────────────────────────────────────────────────────
    # Read NAS clients from database (requires nas table with entries)
    read_clients = yes
    
    # Read group configurations
    read_groups = yes
    
    # Delete stale sessions on startup
    delete_stale_sessions = yes

    # ───────────────────────────────────────────────────────────────────────────
    # SQL User Name - Used in query expansion
    # ───────────────────────────────────────────────────────────────────────────
    sql_user_name = "%{User-Name}"

    # ───────────────────────────────────────════════════════════════════════════
    # CLIENT QUERY - Load NAS/Clients from Database
    # ═══════════════════════════════════════════════════════════════════════════
    # This query loads RADIUS clients from the nas table.
    # Each row defines a NAS that can send RADIUS requests.
    # ───────────────────────────────────────────────────────────────────────────
    client_query = "SELECT id, nasname, shortname, type, secret FROM public.nas"

    # ═══════════════════════════════════════════════════════════════════════════
    # AUTHORIZATION QUERIES
    # ═══════════════════════════════════════════════════════════════════════════

    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM public.radcheck \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM public.radreply \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    # ───────────────────────────────────────────────────────────────────────────
    # Group Queries
    # ───────────────────────────────────────────────────────────────────────────
    group_membership_query = "\
        SELECT groupname \
        FROM public.radusergroup \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority"

    authorize_group_check_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM public.radgroupcheck \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    authorize_group_reply_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM public.radgroupreply \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    # ═══════════════════════════════════════════════════════════════════════════
    # ACCOUNTING QUERIES
    # ═══════════════════════════════════════════════════════════════════════════
    # FreeRADIUS uses a reference to select the appropriate query based on
    # the Acct-Status-Type attribute in the accounting request.
    # ───────────────────────────────────────────────────────────────────────────
    
    accounting {
        reference = "%{tolower:type.%{%{Acct-Status-Type}:-%{Request-Processing-Stage}}.query}"

        type {
            # ───────────────────────────────────────────────────────────────────
            # Accounting-On: NAS has rebooted, close all stale sessions
            # ───────────────────────────────────────────────────────────────────
            accounting-on {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            # ───────────────────────────────────────────────────────────────────
            # Accounting-Off: NAS is shutting down, close all sessions
            # ───────────────────────────────────────────────────────────────────
            accounting-off {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            # ───────────────────────────────────────────────────────────────────
            # Start: New session has begun
            # ───────────────────────────────────────────────────────────────────
            start {
                query = "\
                    INSERT INTO public.radacct \
                        (acctsessionid, acctuniqueid, username, nasipaddress, \
                         nasportid, nasporttype, acctstarttime, acctupdatetime, \
                         acctauthentic, connectinfo_start, acctinputoctets, \
                         acctoutputoctets, calledstationid, callingstationid, \
                         servicetype, framedprotocol, framedipaddress) \
                    VALUES \
                        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                         '%{SQL-User-Name}', '%{NAS-IP-Address}', \
                         '%{%{NAS-Port-Id}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
                         TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                         TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                         '%{Acct-Authentic}', '%{Connect-Info}', \
                         0, 0, \
                         '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                         '%{Service-Type}', '%{Framed-Protocol}', \
                         '%{Framed-IP-Address}')"
            }

            # ───────────────────────────────────────────────────────────────────
            # Interim-Update: Session is still active, update statistics
            # ───────────────────────────────────────────────────────────────────
            interim-update {
                query = "\
                    UPDATE public.radacct \
                    SET acctupdatetime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        framedipaddress = '%{Framed-IP-Address}', \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0}::bigint + \
                            %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0}::bigint + \
                            %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296 \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            # ───────────────────────────────────────────────────────────────────
            # Stop: Session has ended
            # ───────────────────────────────────────────────────────────────────
            stop {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0}::bigint + \
                            %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0}::bigint + \
                            %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296, \
                        acctterminatecause = '%{Acct-Terminate-Cause}', \
                        connectinfo_stop = '%{Connect-Info}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # ═══════════════════════════════════════════════════════════════════════════
    # POST-AUTHENTICATION LOGGING
    # ═══════════════════════════════════════════════════════════════════════════
    # Logs all authentication attempts (both successful and failed)
    # ───────────────────────────────────────────────────────────────────────────
    
    post-auth {
        query = "\
            INSERT INTO public.radpostauth \
                (username, pass, reply, authdate) \
            VALUES \
                ('%{SQL-User-Name}', '%{%{User-Password}:-}', \
                 '%{reply:Packet-Type}', NOW())"
    }
}
