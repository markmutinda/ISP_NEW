# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# FreeRADIUS SQL Configuration (FLAT SYNTAX - THE WORKING VERSION)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

sql {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # ðŸŸ¢ HARDCODED CREDENTIALS (The Fix for 'Auth Failed')
    server = "netily_db"
    port = "5432"
    login = "isp_user"
    password = "2202"
    radius_db = "isp_management"

    pool {
        start = 5
        min = 4
        max = 32
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    # Standard Tables
    authcheck_table = "public.radcheck"
    authreply_table = "public.radreply"
    groupcheck_table = "public.radgroupcheck"
    groupreply_table = "public.radgroupreply"
    usergroup_table = "public.radusergroup"
    acct_table1 = "public.radacct"
    acct_table2 = "public.radacct"
    postauth_table = "public.radpostauth"
    client_table = "public.nas"

    read_clients = yes
    read_groups = yes
    delete_stale_sessions = yes

    # ðŸŸ¢ AUTHENTICATION (Using direct variables)
    authorize_check_query = "SELECT id, username, attribute, value, op FROM public.radcheck WHERE username = '%{User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM public.radreply WHERE username = '%{User-Name}' ORDER BY id"
    group_membership_query = "SELECT groupname FROM public.radusergroup WHERE username = '%{User-Name}' ORDER BY priority"

    # ðŸŸ¢ ACCOUNTING (Nested Syntax - The Fix for 'noop')
    accounting {
        reference = "%{tolower:type.%{Acct-Status-Type}}"

        type {
            start {
                query = "INSERT INTO public.radacct (acctsessionid, acctuniqueid, username, nasipaddress, nasportid, nasporttype, acctstarttime, acctupdatetime, acctauthentic, connectinfo_start, acctinputoctets, acctoutputoctets, calledstationid, callingstationid, servicetype, framedprotocol, framedipaddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{User-Name}', '%{NAS-IP-Address}', '%{NAS-Port-Id}', '%{NAS-Port-Type}', TO_TIMESTAMP(%{integer:Event-Timestamp}), TO_TIMESTAMP(%{integer:Event-Timestamp}), '%{Acct-Authentic}', '%{Connect-Info}', 0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"
            }

            interim-update {
                query = "UPDATE public.radacct SET acctupdatetime = TO_TIMESTAMP(%{integer:Event-Timestamp}), acctinterval = %{%{Acct-Delay-Time}:-0} + %{integer:Event-Timestamp} - EXTRACT(EPOCH FROM acctupdatetime), framedipaddress = '%{Framed-IP-Address}', acctsessiontime = %{%{Acct-Session-Time}:-0}, acctinputoctets = %{%{Acct-Input-Octets}:-0} + %{%{Acct-Input-Gigawords}:-0} * 4294967296, acctoutputoctets = %{%{Acct-Output-Octets}:-0} + %{%{Acct-Output-Gigawords}:-0} * 4294967296 WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
            }

            stop {
                query = "UPDATE public.radacct SET acctstoptime = TO_TIMESTAMP(%{integer:Event-Timestamp}), acctsessiontime = %{%{Acct-Session-Time}:-0}, acctinputoctets = %{%{Acct-Input-Octets}:-0} + %{%{Acct-Input-Gigawords}:-0} * 4294967296, acctoutputoctets = %{%{Acct-Output-Octets}:-0} + %{%{Acct-Output-Gigawords}:-0} * 4294967296, acctterminatecause = '%{Acct-Terminate-Cause}', connectinfo_stop = '%{Connect-Info}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # ðŸŸ¢ POST-AUTH (Nested Syntax)
    post-auth {
        query = "INSERT INTO public.radpostauth (username, pass, reply, authdate, nasipaddress, nasportid) VALUES ('%{User-Name}', '%{User-Password}', '%{reply:Packet-Type}', NOW(), '%{NAS-IP-Address}', '%{NAS-Port-Id}')"
    }
}