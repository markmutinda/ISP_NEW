# ────────────────────────────────────────────────────────────────
# FreeRADIUS SQL Configuration for Netily ISP
# ────────────────────────────────────────────────────────────────
# This file uses the NESTED BLOCK syntax that FreeRADIUS 3.x expects
# for accounting queries. The accounting section uses a "reference"
# directive that points to nested query blocks.
# ────────────────────────────────────────────────────────────────

sql {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # Database Connection (substituted by envsubst at container start)
    server = "${DB_HOST}"
    port = ${DB_PORT}
    login = "${DB_USER}"
    password = "${DB_PASSWORD}"
    radius_db = "${DB_NAME}"

    # Connection Pool Settings
    pool {
        start = 5
        min = 3
        max = 32
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    # Table Configuration - Using public schema
    authcheck_table = "public.radcheck"
    authreply_table = "public.radreply"
    groupcheck_table = "public.radgroupcheck"
    groupreply_table = "public.radgroupreply"
    usergroup_table = "public.radusergroup"
    acct_table1 = "public.radacct"
    acct_table2 = "public.radacct"
    postauth_table = "public.radpostauth"
    client_table = "public.nas"

    read_clients = yes
    read_groups = yes
    delete_stale_sessions = yes

    # SQL User Name
    sql_user_name = "%{User-Name}"

    # Event timestamp for accounting
    event_timestamp_epoch = "%{%{integer:Event-Timestamp}:-%l}"
    event_timestamp = "TO_TIMESTAMP(${event_timestamp_epoch})"

    # ═══════════════════════════════════════════════════════════════
    # AUTHORIZATION QUERIES
    # ═══════════════════════════════════════════════════════════════
    
    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM ${authcheck_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM ${authreply_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    group_membership_query = "\
        SELECT groupname \
        FROM ${usergroup_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority"

    authorize_group_check_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM ${groupcheck_table} \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    authorize_group_reply_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM ${groupreply_table} \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    # ═══════════════════════════════════════════════════════════════
    # ACCOUNTING QUERIES - NESTED BLOCK SYNTAX (REQUIRED!)
    # ═══════════════════════════════════════════════════════════════
    
    accounting {
        # Reference tells FreeRADIUS which query block to use based on Acct-Status-Type
        reference = "%{tolower:type.%{%{Acct-Status-Type}:-%{Request-Processing-Stage}}.query}"

        # Accounting-On: NAS just booted, close all stale sessions
        type.accounting-on {
            query = "\
                UPDATE public.radacct \
                SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                    acctterminatecause = 'NAS-Reboot' \
                WHERE acctstoptime IS NULL \
                AND nasipaddress = '%{NAS-IP-Address}'"
        }

        # Accounting-Off: NAS shutting down, close all sessions  
        type.accounting-off {
            query = "\
                UPDATE public.radacct \
                SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                    acctterminatecause = 'NAS-Reboot' \
                WHERE acctstoptime IS NULL \
                AND nasipaddress = '%{NAS-IP-Address}'"
        }

        # Start: New session beginning
        type.start {
            query = "\
                INSERT INTO public.radacct \
                    (acctsessionid, acctuniqueid, username, nasipaddress, \
                     nasportid, nasporttype, acctstarttime, acctupdatetime, \
                     acctauthentic, connectinfo_start, acctinputoctets, \
                     acctoutputoctets, calledstationid, callingstationid, \
                     servicetype, framedprotocol, framedipaddress) \
                VALUES \
                    ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                     '%{SQL-User-Name}', '%{NAS-IP-Address}', \
                     '%{%{NAS-Port-Id}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
                     TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                     '%{Acct-Authentic}', '%{Connect-Info}', \
                     0, 0, \
                     '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                     '%{Service-Type}', '%{Framed-Protocol}', \
                     '%{Framed-IP-Address}')"
        }

        # Interim-Update: Session still active, update stats
        type.interim-update {
            query = "\
                UPDATE public.radacct \
                SET acctupdatetime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                    framedipaddress = '%{Framed-IP-Address}', \
                    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                    acctinputoctets = %{%{Acct-Input-Octets}:-0} + \
                        %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                    acctoutputoctets = %{%{Acct-Output-Octets}:-0} + \
                        %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296 \
                WHERE acctsessionid = '%{Acct-Session-Id}' \
                AND username = '%{SQL-User-Name}' \
                AND nasipaddress = '%{NAS-IP-Address}'"
        }

        # Stop: Session ended
        type.stop {
            query = "\
                UPDATE public.radacct \
                SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                    acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                    acctinputoctets = %{%{Acct-Input-Octets}:-0} + \
                        %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                    acctoutputoctets = %{%{Acct-Output-Octets}:-0} + \
                        %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296, \
                    acctterminatecause = '%{Acct-Terminate-Cause}', \
                    connectinfo_stop = '%{Connect-Info}' \
                WHERE acctsessionid = '%{Acct-Session-Id}' \
                AND username = '%{SQL-User-Name}' \
                AND nasipaddress = '%{NAS-IP-Address}'"
        }
    }

    # ═══════════════════════════════════════════════════════════════
    # POST-AUTH LOGGING
    # ═══════════════════════════════════════════════════════════════
    
    post-auth {
        query = "\
            INSERT INTO public.radpostauth \
                (username, pass, reply, authdate, nasipaddress, nasportid) \
            VALUES \
                ('%{SQL-User-Name}', '%{%{User-Password}:-}', \
                 '%{reply:Packet-Type}', NOW(), \
                 '%{NAS-IP-Address}', '%{NAS-Port-Id}')"
    }
}
