# ────────────────────────────────────────────────────────────────
# FreeRADIUS SQL Configuration for Netily ISP
# ────────────────────────────────────────────────────────────────

sql {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    server = "${DB_HOST}"
    port = ${DB_PORT}
    login = "${DB_USER}"
    password = "${DB_PASSWORD}"
    radius_db = "${DB_NAME}"

    pool {
        start = 5
        min = 3
        max = 32
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    read_clients = yes
    read_groups = yes
    delete_stale_sessions = yes
    client_table = "public.nas"

    sql_user_name = "%{User-Name}"

    # ═══════════════════════════════════════════════════════════════
    # AUTHORIZATION QUERIES
    # ═══════════════════════════════════════════════════════════════

    authorize_check_query = "\
        SELECT id, username, attribute, value, op \
        FROM public.radcheck \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    authorize_reply_query = "\
        SELECT id, username, attribute, value, op \
        FROM public.radreply \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY id"

    group_membership_query = "\
        SELECT groupname \
        FROM public.radusergroup \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority"

    authorize_group_check_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM public.radgroupcheck \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    authorize_group_reply_query = "\
        SELECT id, groupname, attribute, value, op \
        FROM public.radgroupreply \
        WHERE groupname = '%{SQL-Group}' \
        ORDER BY id"

    # ═══════════════════════════════════════════════════════════════
    # ACCOUNTING QUERIES - PROPER NESTED STRUCTURE
    # ═══════════════════════════════════════════════════════════════

    accounting {
        reference = "%{tolower:type.%{%{Acct-Status-Type}:-%{Request-Processing-Stage}}.query}"

        type {
            accounting-on {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            accounting-off {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctterminatecause = 'NAS-Reboot' \
                    WHERE acctstoptime IS NULL \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            start {
                query = "\
                    INSERT INTO public.radacct \
                        (acctsessionid, acctuniqueid, username, nasipaddress, \
                         nasportid, nasporttype, acctstarttime, acctupdatetime, \
                         acctauthentic, connectinfo_start, acctinputoctets, \
                         acctoutputoctets, calledstationid, callingstationid, \
                         servicetype, framedprotocol, framedipaddress) \
                    VALUES \
                        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', \
                         '%{SQL-User-Name}', '%{NAS-IP-Address}', \
                         '%{%{NAS-Port-Id}:-%{NAS-Port}}', '%{NAS-Port-Type}', \
                         TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                         TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                         '%{Acct-Authentic}', '%{Connect-Info}', \
                         0, 0, \
                         '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                         '%{Service-Type}', '%{Framed-Protocol}', \
                         '%{Framed-IP-Address}')"
            }

            interim-update {
                query = "\
                    UPDATE public.radacct \
                    SET acctupdatetime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        framedipaddress = '%{Framed-IP-Address}', \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0}::bigint + \
                            %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0}::bigint + \
                            %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296 \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            stop {
                query = "\
                    UPDATE public.radacct \
                    SET acctstoptime = TO_TIMESTAMP(%{%{integer:Event-Timestamp}:-%l}), \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0}::bigint + \
                            %{%{Acct-Input-Gigawords}:-0}::bigint * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0}::bigint + \
                            %{%{Acct-Output-Gigawords}:-0}::bigint * 4294967296, \
                        acctterminatecause = '%{Acct-Terminate-Cause}', \
                        connectinfo_stop = '%{Connect-Info}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # ═══════════════════════════════════════════════════════════════
    # POST-AUTH LOGGING
    # ═══════════════════════════════════════════════════════════════

    post-auth {
        query = "\
            INSERT INTO public.radpostauth \
                (username, pass, reply, authdate, nasipaddress, nasportid) \
            VALUES \
                ('%{SQL-User-Name}', '%{%{User-Password}:-}', \
                 '%{reply:Packet-Type}', NOW(), \
                 '%{NAS-IP-Address}', '%{NAS-Port-Id}')"
    }
}
