# ────────────────────────────────────────────────────────────────
# FreeRADIUS SQL Module Configuration for Netily
# Connects to PostgreSQL to share data with Django
# ────────────────────────────────────────────────────────────────

sql {
    # PostgreSQL driver
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # Database connection settings
    # These match the Django database configuration
    server = "${env.DB_HOST:-db}"
    port = ${env.DB_PORT:-5432}
    login = "${env.DB_USER:-isp_user}"
    password = "${env.DB_PASSWORD:-2202}"
    radius_db = "${env.DB_NAME:-isp_management}"

    # Connection pooling
    pool {
        start = 5
        min = 4
        max = 32
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    # ────────────────────────────────────────────────────────────────
    # TABLE NAMES - Must match Django RADIUS models
    # ────────────────────────────────────────────────────────────────

    # User authentication tables
    authcheck_table = "radcheck"
    authreply_table = "radreply"

    # Group tables
    groupcheck_table = "radgroupcheck"
    groupreply_table = "radgroupreply"
    usergroup_table = "radusergroup"

    # Accounting tables
    acct_table1 = "radacct"
    acct_table2 = "radacct"

    # Post-auth logging
    postauth_table = "radpostauth"

    # NAS/Client table (routers)
    client_table = "nas"

    # Read NAS clients from database
    read_clients = yes

    # Read groups
    read_groups = yes

    # Delete stale sessions on startup
    delete_stale_sessions = yes

    # ────────────────────────────────────────────────────────────────
    # SQL QUERIES - Standard FreeRADIUS queries for PostgreSQL
    # ────────────────────────────────────────────────────────────────

    # Group membership query
    group_membership_query = "\
        SELECT groupname \
        FROM ${usergroup_table} \
        WHERE username = '%{SQL-User-Name}' \
        ORDER BY priority"

    # ────────────────────────────────────────────────────────────────
    # ACCOUNTING QUERIES
    # ────────────────────────────────────────────────────────────────

    accounting {
        # Log type mappings
        type {
            start {
                query = "\
                    INSERT INTO ${....acct_table1} \
                        (acctsessionid, acctuniqueid, username, \
                         nasipaddress, nasportid, nasporttype, \
                         acctstarttime, acctupdatetime, \
                         acctauthentic, connectinfo_start, \
                         acctinputoctets, acctoutputoctets, \
                         calledstationid, callingstationid, \
                         servicetype, framedprotocol, \
                         framedipaddress) \
                    VALUES \
                        ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', \
                         '%{NAS-IP-Address}', '%{NAS-Port-Id}', '%{NAS-Port-Type}', \
                         TO_TIMESTAMP(%{integer:Event-Timestamp}), TO_TIMESTAMP(%{integer:Event-Timestamp}), \
                         '%{Acct-Authentic}', '%{Connect-Info}', \
                         0, 0, \
                         '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                         '%{Service-Type}', '%{Framed-Protocol}', \
                         '%{Framed-IP-Address}')"
            }

            interim-update {
                query = "\
                    UPDATE ${....acct_table1} SET \
                        acctupdatetime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
                        acctinterval = %{%{Acct-Delay-Time}:-0} + %{integer:Event-Timestamp} - \
                            EXTRACT(EPOCH FROM acctupdatetime), \
                        framedipaddress = '%{Framed-IP-Address}', \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0} + \
                            %{%{Acct-Input-Gigawords}:-0} * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0} + \
                            %{%{Acct-Output-Gigawords}:-0} * 4294967296 \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }

            stop {
                query = "\
                    UPDATE ${....acct_table1} SET \
                        acctstoptime = TO_TIMESTAMP(%{integer:Event-Timestamp}), \
                        acctsessiontime = %{%{Acct-Session-Time}:-0}, \
                        acctinputoctets = %{%{Acct-Input-Octets}:-0} + \
                            %{%{Acct-Input-Gigawords}:-0} * 4294967296, \
                        acctoutputoctets = %{%{Acct-Output-Octets}:-0} + \
                            %{%{Acct-Output-Gigawords}:-0} * 4294967296, \
                        acctterminatecause = '%{Acct-Terminate-Cause}', \
                        connectinfo_stop = '%{Connect-Info}' \
                    WHERE acctsessionid = '%{Acct-Session-Id}' \
                    AND username = '%{SQL-User-Name}' \
                    AND nasipaddress = '%{NAS-IP-Address}'"
            }
        }
    }

    # ────────────────────────────────────────────────────────────────
    # POST-AUTH LOGGING
    # ────────────────────────────────────────────────────────────────

    post-auth {
        query = "\
            INSERT INTO ${..postauth_table} \
                (username, pass, reply, authdate, nasipaddress, nasportid) \
            VALUES \
                ('%{SQL-User-Name}', '%{%{User-Password}:-%{Chap-Password}}', \
                 '%{reply:Packet-Type}', NOW(), '%{NAS-IP-Address}', '%{NAS-Port-Id}')"
    }
}
