version: '3.8'

# ============================================================================
# NETILY ISP - RADIUS & VPN DOCKER SERVICES
# ============================================================================
# This docker-compose runs FreeRADIUS which connects to your LOCAL PostgreSQL
# database (same database that Django uses).
#
# Architecture:
#   - Django (Windows) ──► Local PostgreSQL ◄── FreeRADIUS (Docker)
#   - Both share the same database, so Django can manage RADIUS users
# ============================================================================

services:
  # ──────────────────────────────────────────────────────────────────────────
  # FREERADIUS SERVER
  # Connects to your LOCAL PostgreSQL to authenticate PPPoE/Hotspot users
  # ──────────────────────────────────────────────────────────────────────────
  radius:
    build:
      context: .
      dockerfile: docker/Dockerfile.radius
    container_name: netily_radius
    ports:
      - "1812:1812/udp"   # Authentication Port (MikroTik sends auth requests here)
      - "1813:1813/udp"   # Accounting Port (Session start/stop/update)
    environment:
      # Connect to LOCAL PostgreSQL on host machine
      # host.docker.internal resolves to the Windows host from inside Docker
      - DB_HOST=host.docker.internal
      - DB_PORT=5432
      - DB_USER=postgres
      - DB_PASS=1234
      - DB_NAME=isp_management
      - DB_SCHEMA=tenant_yellow1
      - RADIUS_KEY=testing123  # Shared secret - must match MikroTik config
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ──────────────────────────────────────────────────────────────────────────
  # PGADMIN (Optional - Database GUI)
  # Access at http://localhost:5050
  # ──────────────────────────────────────────────────────────────────────────
  pgadmin:
    image: dpage/pgadmin4
    container_name: netily_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@netily.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    restart: unless-stopped

# Note: No postgres volume needed - we use your local PostgreSQL